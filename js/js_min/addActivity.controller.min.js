/*! yiqi_web 2016-12-31 */
!function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(){laydate({elem:"#startTime",istime:!0,format:"YYYY-MM-DD hh:mm:ss",min:c("toTime")(e.dateNowStamp),isclear:!1,istoday:!1,choose:function(b){a.$apply(function(){w.submitForm.startTime=b})}})}function j(){laydate({elem:"#endTime",istime:!0,format:"YYYY-MM-DD hh:mm:ss",min:c("toTime")(e.dateNowStamp),isclear:!1,istoday:!1,choose:function(b){a.$apply(function(){w.submitForm.endTime=b})}})}function k(){laydate({elem:"#ticketEndTime",istime:!0,format:"YYYY-MM-DD hh:mm:ss",min:c("toTime")(e.dateNowStamp),isclear:!1,istoday:!1,choose:function(b){a.$apply(function(){w.chargeTicketForm.ticket_time=b})}})}function l(a,b,c){function d(){w.submitForm.address.city=""}function e(a){w[b]=a,c&&c()}g.getCityList(w.provinceArray,a,d,e)}function m(){f.getActivityType().success(function(a){if(200!=a.ret)return window.showAutoDialog(a.msg),!1;var b=a.data;2e4==b.code&&(w.cat_id_array=b.cate,w.submitForm.cat_id=b.cate[0].name,w.cat_way_array=b.finace,w.submitForm.cat_way=b.finace[0].name,w.cat_tag_array=b.tags)})}function n(){w.add_ticket_mask=!0,w.add_free_dialog=!0}function o(){var b={uid:a.userInfo.id,ticket_name:"免费票",ticket_num:w.freeTicket_num};a.$broadcast("public.show",["loading_panel"]),f.addFreeTicket(b).success(function(b){try{if(200!=b.ret)return window.showAlertTip(b.msg),!1;var c=b.data;2e4==c.code?(window.showAlertTip("添加成功"),w.addFreeDialogCancel(),w.freeTicketArray.push(c.list[0]),w.submitForm.free_ticket.push(c.list[0].id)):window.showAlertTip(b.msg)}catch(a){}finally{a.$broadcast("public.hide",["loading_panel"])}})}function p(){w.add_ticket_mask=!1,w.add_free_dialog=!1}function q(){w.submitForm.free_ticket=[],w.freeTicketArray=[],window.showAlertTip("删除成功")}function r(){w.add_ticket_mask=!0,w.add_ticket_dialog=!0,angular.element("body").css("margin-top","0")}function s(){var b={uid:a.userInfo.id,ticket_name:w.chargeTicketForm.ticket_name,ticket_time:c("toTimeStamp")(w.chargeTicketForm.ticket_time),ticket_price:w.chargeTicketForm.ticket_price,ticket_decription:w.chargeTicketForm.ticket_decription,ticket_num:w.chargeTicketForm.ticket_num},d=/^\-?\d*$/;return b.ticket_name?b.ticket_time?b.ticket_price&&b.ticket_price>1?b.ticket_num&&d.test(b.ticket_num)&&b.ticket_num>1?b.ticket_decription.trim().length>0?(a.$broadcast("public.show",["loading_panel"]),void f.addChargeTicket(b).success(function(b){try{if(200!=b.ret)return window.showAlertTip(b.msg),!1;var c=b.data;2e4==c.code?(w.addTicketDialogCancel(),window.showAlertTip("添加成功"),w.chargeTicketArray.push(c.list[0]),w.submitForm.charge_ticket.push(c.list[0].id),w.chargeTicketForm={ticket_name:"",ticket_time:"",ticket_price:"",ticket_num:"",ticket_decription:""}):window.showAlertTip(b.msg)}catch(a){}finally{a.$broadcast("public.hide",["loading_panel"])}})):(window.showAlertTip("请填写费用说明"),!1):(window.showAlertTip("收费票数量为必须大于0的整数"),!1):(window.showAlertTip("价格必须大于0"),!1):(window.showAlertTip("时间不能为空"),!1):(window.showAlertTip("票价类型不能为空"),!1)}function t(){w.add_ticket_mask=!1,w.add_ticket_dialog=!1,angular.element("body").css("margin-top","auto")}function u(a){w.chargeTicketArray.splice(a,1),w.submitForm.charge_ticket.splice(a,1),window.showAlertTip("删除成功")}function v(){if(!w.submitForm.address.province||!w.submitForm.address.city)return window.showAutoDialog("请先选择项目地点的省份、城市地区"),!1;w.submitForm.cat_tag=[];for(var b=angular.element("#tags").find("li.active"),d=0;d<b.length;d++)w.submitForm.cat_tag.push(b[d].getAttribute("data-name"));if(0==w.submitForm.free_ticket.length&&0==w.submitForm.charge_ticket.length)return window.showAutoDialog("请先添加免费票或者收费票！"),!1;if(w.submitForm.description.indexOf("<img")<0&&w.submitForm.description.trim().length<30)return window.showAutoDialog("详情描述字数过少，请更加详细地描述一下！"),!1;var e=w.submitForm.charge_ticket.slice(0);e=e.concat(w.submitForm.free_ticket);var g={uid:a.userInfo.id,username:a.userInfo.user_name,title:w.submitForm.title,people:w.submitForm.people,startTime:c("toTimeStamp")(w.submitForm.startTime),endTime:c("toTimeStamp")(w.submitForm.endTime),address:JSON.stringify(w.submitForm.address),cat_id:w.submitForm.cat_id,cat_way:w.submitForm.cat_way,cat_tag:w.submitForm.cat_tag.join(","),brief:w.submitForm.brief,description:w.submitForm.description,poster_img:w.submitForm.poster_img,ticket_id:e.join(","),verify_coder:w.submitForm.verify_coder,activ_index:w.submitForm.activ_index};a.$broadcast("public.show",["loading_panel"]),w.submitFlag=!1,f.addActivity(g).success(function(b){try{if(200!=b.ret)return window.showAutoDialog(b.msg),!1;2e4==b.data.code?(window.showAutoDialog(b.data.msg),h.go("personal.myActivity")):window.showAutoDialog(b.data.msg)}catch(a){}finally{w.submitFlag=!0,a.$broadcast("public.hide",["loading_panel"])}})}angular.element(b).scrollTop(0),a.title="发布活动";var w=this;return a.userInfo.id?a.userInfo.mobile?"0"!=a.userInfo.identity_conditions?(window.showAlertTip(["您不是主办方，无权限发布活动",3e3]),h.go("index"),!1):(w.agree=!0,w.submitForm={title:"",people:"",startTime:c("toTime")(e.dateNowStamp),endTime:c("toTime")(e.dateOneMonthStamp),address:{province:"",city:"",location:""},cat_id:"",cat_way:"",cat_tag:[],brief:"",description:"",poster_img:"",free_ticket:[],charge_ticket:[],verify_coder:"",activ_index:""},w.provinceArray=[],w.cityArray=[],w.cat_id_array=[],w.cat_way_array=[],w.cat_tag_array=[],w.add_ticket_mask=!1,w.add_free_dialog=!1,w.add_ticket_dialog=!1,w.ticketEndTime="",w.freeTicket_num="",w.freeTicketArray=[],w.chargeTicketArray=[],w.chargeTicketForm={ticket_name:"",ticket_time:c("toTime")(e.dateOneMonthStamp),ticket_price:"",ticket_num:"",ticket_decription:""},w.chargeTicketSetArray=[{id:"单人票",name:"单人票"},{id:"双人票",name:"双人票"},{id:"三人票",name:"三人票"}],w.setStartTime=i,w.setEndTime=j,w.getActivityType=m,w.getCityList=l,w.showAddFreeDialog=n,w.addFreeDialogConfirm=o,w.addFreeDialogCancel=p,w.removeFreeTicket=q,w.showAddTicketDialog=r,w.addTicketDialogConfirm=s,w.addTicketDialogCancel=t,w.setTicketEndTime=k,w.removeChargeTicket=u,w.addActivitySubmit=v,void function(){w.getActivityType(),g.getProvinceList(function(a){w.provinceArray=a})}()):(window.showAutoDialog("请先到安全中心绑定手机"),h.go("personal.safe"),!1):(h.go("login"),!1)}app.import("/app/Tpl/web/js/directive/contenteditable.directive.js","contenteditable.directive"),app.import("/app/Tpl/web/js/directive/tooltip.directive.js","tooltip.directive"),app.import("/app/Tpl/web/js/service/service_min/public.service.min.js","public.service"),app.import("/app/Tpl/web/js/service/service_min/activity.service.min.js","activity.service"),app.import("/app/Tpl/web/js/directive/imgUpload.directive.js","imgUpload.directive"),app.import("/app/Tpl/web/js/service/service_min/address.service.min.js","address.service"),app.import("/app/Tpl/web/js/directive/limitSize.directive.js","limitSize.directive"),app.import("/app/Tpl/web/js/directive/integer.directive.js","integer.directive"),app.addController("addActivityController",a),a.$inject=["$rootScope","$window","$filter","$timeout","publicService","activityService","addressService","$state"]}();