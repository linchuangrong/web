/*! yiqi_web 2016-12-31 */
!function(){"use strict";function a(a,b,c,d,e,f,g,h,i){function j(){laydate({elem:"#startTime",istime:!0,format:"YYYY-MM-DD hh:mm:ss",min:c("toTime")(e.dateNowStamp),isclear:!1,istoday:!1,choose:function(b){a.$apply(function(){y.submitForm.startTime=b})}})}function k(){laydate({elem:"#endTime",istime:!0,format:"YYYY-MM-DD hh:mm:ss",min:c("toTime")(e.dateNowStamp),isclear:!1,istoday:!1,choose:function(b){a.$apply(function(){y.submitForm.endTime=b})}})}function l(){laydate({elem:"#ticketEndTime",istime:!0,format:"YYYY-MM-DD hh:mm:ss",min:c("toTime")(e.dateNowStamp),isclear:!1,istoday:!1,choose:function(b){a.$apply(function(){y.chargeTicketForm.ticket_time=b})}})}function m(a,b,c){function d(){y.submitForm.address.city=""}function e(a){y[b]=a,c&&c()}g.getCityList(y.provinceArray,a,d,e)}function n(){f.getActivityType().success(function(a){if(200!=a.ret)return window.showAutoDialog(a.msg),!1;var b=a.data;if(2e4==b.code){y.cat_id_array=b.cate,y.submitForm.cat_id=y.editForm.cate_id,y.cat_way_array=b.finace,y.submitForm.cat_way=y.editForm.cate_way,y.cat_tag_array=b.tags;for(var c=0;c<y.submitForm.cat_tag.length;c++)for(var d=0;d<y.cat_tag_array.length;d++)if(y.submitForm.cat_tag[c]==y.cat_tag_array[d].name){y.cat_tag_array[d].active=!0;break}}})}function o(a){var b={ticket_id:a};f.getTicketInfo(b).success(function(a){return 200!=a.ret?(window.showAutoDialog(a.msg),!1):void(2e4==a.data.code&&(null==a.data.list.ticket_price||""==a.data.list.ticket_price?(y.freeTicketArray.push(a.data.list),y.submitForm.free_ticket.push(a.data.list.id)):(y.chargeTicketArray.push(a.data.list),y.submitForm.charge_ticket.push(a.data.list.id))))})}function p(){y.add_ticket_mask=!0,y.add_free_dialog=!0}function q(){var b={uid:a.userInfo.id,ticket_name:"免费票",ticket_num:y.freeTicket_num};a.$broadcast("public.show",["loading_panel"]),f.addFreeTicket(b).success(function(b){try{if(200!=b.ret)return window.showAlertTip(b.msg),!1;var c=b.data;2e4==c.code?(window.showAlertTip("添加成功"),y.addFreeDialogCancel(),y.freeTicketArray.push(c.list[0]),y.submitForm.free_ticket.push(c.list[0].id)):window.showAlertTip(b.msg)}catch(a){}finally{a.$broadcast("public.hide",["loading_panel"])}})}function r(){y.add_ticket_mask=!1,y.add_free_dialog=!1}function s(){y.submitForm.free_ticket=[],y.freeTicketArray=[],window.showAlertTip("删除成功")}function t(){y.add_ticket_mask=!0,y.add_ticket_dialog=!0,angular.element("body").css("margin-top","0")}function u(){var b={uid:a.userInfo.id,ticket_name:y.chargeTicketForm.ticket_name,ticket_time:c("toTimeStamp")(y.chargeTicketForm.ticket_time),ticket_price:y.chargeTicketForm.ticket_price,ticket_decription:y.chargeTicketForm.ticket_decription,ticket_num:y.chargeTicketForm.ticket_num},d=/^\-?\d*$/;return b.ticket_name?b.ticket_time?b.ticket_price&&b.ticket_price>1?b.ticket_num&&d.test(b.ticket_num)&&b.ticket_num>1?b.ticket_decription.trim().length>0?(a.$broadcast("public.show",["loading_panel"]),void f.addChargeTicket(b).success(function(b){try{if(200!=b.ret)return window.showAlertTip(b.msg),!1;var c=b.data;2e4==c.code?(y.addTicketDialogCancel(),window.showAlertTip("添加成功"),y.chargeTicketArray.push(c.list[0]),y.submitForm.charge_ticket.push(c.list[0].id),y.chargeTicketForm={ticket_name:"",ticket_time:"",ticket_price:"",ticket_num:"",ticket_decription:""}):window.showAlertTip(b.msg)}catch(a){}finally{a.$broadcast("public.hide",["loading_panel"])}})):(window.showAlertTip("请填写费用说明"),!1):(window.showAlertTip("收费票数量为必须大于0的整数"),!1):(window.showAlertTip("价格必须大于0"),!1):(window.showAlertTip("时间不能为空"),!1):(window.showAlertTip("票价类型不能为空"),!1)}function v(){y.add_ticket_mask=!1,y.add_ticket_dialog=!1,angular.element("body").css("margin-top","auto")}function w(a){y.chargeTicketArray.splice(a,1),y.submitForm.charge_ticket.splice(a,1),window.showAlertTip("删除成功")}function x(){if(!y.submitForm.address.province||!y.submitForm.address.city)return window.showAutoDialog("请先选择项目地点的省份、城市地区"),!1;y.submitForm.cat_tag=[];for(var b=angular.element("#tags").find("li.active"),d=0;d<b.length;d++)y.submitForm.cat_tag.push(b[d].getAttribute("data-name"));if(0==y.submitForm.free_ticket.length&&0==y.submitForm.charge_ticket.length)return window.showAutoDialog("请先添加免费票或者收费票！"),!1;if(y.submitForm.description.indexOf("<img")<0||y.submitForm.description.trim().length<30)return window.showAutoDialog("详情描述字数过少，请更加详细地描述一下！"),!1;var e=y.submitForm.charge_ticket.slice(0);e=e.concat(y.submitForm.free_ticket);var g={deal_id:i.id,uid:a.userInfo.id,username:a.userInfo.user_name,title:y.submitForm.title,people:y.submitForm.people,startTime:c("toTimeStamp")(y.submitForm.startTime),endTime:c("toTimeStamp")(y.submitForm.endTime),address:JSON.stringify(y.submitForm.address),cat_id:y.submitForm.cat_id,cat_way:y.submitForm.cat_way,cat_tag:y.submitForm.cat_tag.join(","),brief:y.submitForm.brief,description:y.submitForm.description,poster_img:y.submitForm.poster_img,ticket_id:e.join(","),verify_coder:y.submitForm.verify_coder,activ_index:y.submitForm.activ_index};y.submitFlag=!1,f.addActivity(g).success(function(a){try{if(200!=a.ret)return window.showAutoDialog(a.msg),!1;2e4==a.data.code?(window.showAutoDialog(a.data.msg),h.go("personal.myActivity")):window.showAutoDialog(a.data.msg)}catch(a){}finally{y.submitFlag=!0}})}angular.element(b).scrollTop(0),a.title="发布活动";var y=this;return"0"!=a.userInfo.identity_conditions?(window.showAlertTip(["您不是主办方，无权限发布活动",3e3]),h.go("index"),!1):a.userInfo.mobile?(y.agree=!0,y.submitForm={title:"",people:"",startTime:c("toTime")(e.dateNowStamp),endTime:c("toTime")(e.dateOneMonthStamp),address:{province:"",city:"",location:""},cat_id:"",cat_way:"",cat_tag:[],brief:"",description:"",poster_img:"",free_ticket:[],charge_ticket:[],verify_coder:"",activ_index:""},y.editForm={},y.provinceArray=[],y.cityArray=[],y.cat_id_array=[],y.cat_way_array=[],y.cat_tag_array=[],y.add_ticket_mask=!1,y.add_free_dialog=!1,y.add_ticket_dialog=!1,y.ticketEndTime="",y.freeTicket_num="",y.freeTicketArray=[],y.chargeTicketArray=[],y.chargeTicketForm={ticket_name:"",ticket_time:c("toTime")(e.dateOneMonthStamp),ticket_price:"",ticket_num:"",ticket_decription:""},y.chargeTicketSetArray=[{id:"单人票",name:"单人票"},{id:"双人票",name:"双人票"},{id:"三人票",name:"三人票"}],y.setStartTime=j,y.setEndTime=k,y.getActivityType=n,y.getTicketInfo=o,y.getCityList=m,y.showAddFreeDialog=p,y.addFreeDialogConfirm=q,y.addFreeDialogCancel=r,y.removeFreeTicket=s,y.showAddTicketDialog=t,y.addTicketDialogConfirm=u,y.addTicketDialogCancel=v,y.setTicketEndTime=l,y.removeChargeTicket=w,y.addActivitySubmit=x,void function(){if(i.id){var b={id:i.id,username:a.userInfo.user_name};f.detail(b).success(function(a){if(200!=a.ret)return window.showAutoDialog(a.msg),!1;if(2e4==a.data.code){y.editForm=a.data.list[0],y.submitForm.title=y.editForm.name,y.submitForm.people=y.editForm.max_people,y.submitForm.startTime=c("toTime")(y.editForm.begin_time),y.submitForm.endTime=c("toTime")(y.editForm.end_time),y.submitForm.address.location=y.editForm.address,y.submitForm.cat_tag=y.editForm.tags.split(","),y.submitForm.brief=y.editForm.brief,y.submitForm.description=y.editForm.description,y.submitForm.poster_img=y.editForm.image,y.submitForm.activ_index=y.editForm.activ_index,y.getActivityType(),g.getProvinceList(function(a){y.provinceArray=a,y.submitForm.address.province=y.editForm.province,y.getCityList(y.editForm.province,"cityArray",function(){y.submitForm.address.city=y.editForm.city})});for(var b=y.editForm.ticket_id.split(","),d=0;d<b.length;d++)y.getTicketInfo(b[d])}else window.showAutoDialog(a.data.msg)})}}()):(window.showAutoDialog("请先到安全中心绑定手机"),h.go("personal.safe"),!1)}app.import("/app/Tpl/web/js/directive/contenteditable.directive.js","contenteditable.directive"),app.import("/app/Tpl/web/js/directive/tooltip.directive.js","tooltip.directive"),app.import("/app/Tpl/web/js/service/service_min/public.service.min.js","public.service"),app.import("/app/Tpl/web/js/service/service_min/activity.service.min.js","activity.service"),app.import("/app/Tpl/web/js/directive/imgUpload.directive.js","imgUpload.directive"),app.import("/app/Tpl/web/js/service/service_min/address.service.min.js","address.service"),app.import("/app/Tpl/web/js/directive/limitSize.directive.js","limitSize.directive"),app.import("/app/Tpl/web/js/directive/integer.directive.js","integer.directive"),app.addController("updateActivityController",a),a.$inject=["$rootScope","$window","$filter","$timeout","publicService","activityService","addressService","$state","$stateParams"]}();