/*! yiqi_web 2016-12-30 */
!function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(){laydate({elem:"#deal_days",istime:!0,format:"YYYY-MM-DD hh:mm:ss",min:h("toTime")(e.dateNowStamp),isclear:!1,istoday:!1,choose:function(a){b.$apply(function(){s.submitForm.deal_days=a})}})}function j(){d.getCrowdFundTypeList().success(function(a){return 200!=a.ret?(window.showAutoDialog(a.msg),!1):void(2e4==a.data.code?(s.crowdFundTypeArray=a.data.list,s.submitForm.welfare_id=a.data.list[0].id,s.submitForm.welfare_name=a.data.list[0].name):window.showAutoDialog(a.data.msg))})}function k(a,b){s.submitForm.welfare_id=a,s.submitForm.welfare_name=b}function l(a,b,c){function d(){s.submitForm.address.city=""}function e(a){s[b]=a,c&&c()}f.getCityList(s.provinceArray,a,d,e)}function m(b){if("crowdFundPanel2"==b){if(!s.submitForm.welfare_id)return window.showAlertTip("请选择众筹类型"),!1;if(!s.submitForm.title)return window.showAlertTip("请填写项目名称"),!1;if(!s.submitForm.brief)return window.showAlertTip("请填写筹款目的"),!1;if(!s.submitForm.address.province)return window.showAlertTip("请选择省份"),!1;if(!s.submitForm.address.city)return window.showAlertTip("请选择城市"),!1;if(!s.submitForm.address.location)return window.showAlertTip("请填写详细地址"),!1;if(!a.submitForm.limit_price.$valid)return window.showAlertTip("请填写正确的筹资金额"),!1;if(!s.submitForm.deal_days)return window.showAlertTip("请填写筹资结束时间"),!1;if(!s.submitForm.tags_match)return window.showAlertTip("请填写自定义标签"),!1;if(!s.submitForm.image)return window.showAlertTip("请上传封面图片"),!1}angular.element(c).scrollTop(0),s.showPanel={crowdFundPanel1:!1,crowdFundPanel2:!1},s.showPanel[b]=!0}function n(){s.show.add_repay_dialog=!0}function o(){if(0==s.flag.addRepayFlag)return!1;if(!s.repayForm.type)return window.showAlertTip("请选择回报类型"),!1;if("1"==s.repayForm.type||"2"==s.repayForm.type){var a=/^\-?\d*$/;if(!s.repayForm.item_name)return window.showAlertTip("请填写回报标题"),!1;if(!s.repayForm.description)return window.showAlertTip("请填写回报内容"),!1;if(!(s.repayForm.delivery_fee&&s.repayForm.delivery_fee>0))return window.showAlertTip("请填写正确的支持金额"),!1;if(!(s.repayForm.limit_user&&a.test(s.repayForm.limit_user)&&s.repayForm.limit_user>1))return window.showAlertTip("人数上限为大于0的整数"),!1;if(!(s.repayForm.repaid_day&&a.test(s.repayForm.repaid_day)&&s.repayForm.repaid_day>0))return window.showAlertTip("请填写正确的回报时间值"),!1;if(!s.repayForm.item_image)return window.showAlertTip("请上传图片"),!1}var c={username:b.userInfo.user_name,type:s.repayForm.type,item_name:s.repayForm.item_name,description:s.repayForm.description,delivery_fee:s.repayForm.delivery_fee,limit_user:s.repayForm.limit_user,repaid_day:s.repayForm.repaid_day,item_image:s.repayForm.item_image};b.$broadcast("public.show",["loading_panel"]),s.flag.addRepayFlag=!1,d.creatRepay(c).success(function(a){try{if(200!=a.ret)return window.showAutoDialog(a.msg),!1;2e4==a.data.code?(window.showAlertTip(a.data.msg),s.show.add_repay_dialog=!1,s.repayArray.push(a.data.list),s.submitForm.item_id.push(a.data.list.id)):window.showAutoDialog(a.data.msg)}catch(a){}finally{b.$broadcast("public.hide",["loading_panel"]),s.flag.addRepayFlag=!0}})}function p(){s.show.add_repay_dialog=!1}function q(a,b){s.repayArray.splice(a,1),s.submitForm.item_id.splice(a,1),window.showAlertTip("删除成功")}function r(){if(0==s.flag.submitFlag)return!1;if(s.submitForm.description.indexOf("<img")<0&&s.submitForm.description.trim().length<30)return window.showAutoDialog("详情描述字数过少，请更加详细地描述一下！"),!1;if("众筹"==s.submitForm.welfare_name)if("1"==s.submitForm.hasRepay){if(0==s.submitForm.item_id.length)return window.showAlertTip("请添加至少一个回报"),!1}else s.repayArray=[],s.submitForm.item_id=[];else s.repayArray=[],s.submitForm.item_id=[];var a={uid:b.userInfo.id,username:b.userInfo.user_name,welfare_id:s.submitForm.welfare_id,title:s.submitForm.title,brief:s.submitForm.brief,address:JSON.stringify({province:s.submitForm.address.province,city:s.submitForm.address.city,location:s.submitForm.address.location}),limit_price:s.submitForm.limit_price,deal_days:h("toTimeStamp")(s.submitForm.deal_days),tags_match:s.submitForm.tags_match,image:s.submitForm.image,vedio:s.submitForm.vedio,description:s.submitForm.description,item_id:s.submitForm.item_id.join(",")};b.$broadcast("public.show",["loading_panel"]),s.flag.submitFlag=!1,d.addCrowdFund(a).success(function(a){try{if(200!=a.ret)return window.showAutoDialog(a.msg),!1;2e4==a.data.code?(window.showAlertTip(a.data.msg),s.show.add_repay_dialog=!1,g.go("personal.myCrowdFund")):window.showAutoDialog(a.data.msg)}catch(a){}finally{b.$broadcast("public.hide",["loading_panel"]),s.flag.submitFlag=!0}})}angular.element(c).scrollTop(0),b.title="发起众筹";var s=this;return b.userInfo.id?b.userInfo.mobile?"0"!=b.userInfo.identity_conditions?(window.showAlertTip(["您不是主办方，无权限发布筹款",3e3]),g.go("index"),!1):(s.crowdFundTypeArray=[],s.provinceArray=[],s.cityArray=[],s.repayArray=[],s.show={add_repay_dialog:!1},s.flag={addRepayFlag:!0,submitFlag:!0},s.showPanel={crowdFundPanel1:!0,crowdFundPanel2:!1},s.repayForm={type:1,item_name:"",description:"",delivery_fee:null,limit_user:null,repaid_day:null,item_image:""},s.submitForm={welfare_id:"",welfare_name:"",title:"",brief:"",address:{province:"",city:"",location:""},limit_price:null,deal_days:h("toTime")(e.dateOneMonthStamp),tags_match:"",image:"",vedio:"",description:"",item_id:[],hasRepay:"1"},s.getCrowdFundTypeList=j,s.setCrowdFundType=k,s.setDealDays=i,s.getCityList=l,s.goToPanel=m,s.showRepayDialog=n,s.alertDialogConfirm=o,s.alertDialogCancel=p,s.deleteRepay=q,s.submit=r,void function(){s.getCrowdFundTypeList(),f.getProvinceList(function(a){s.provinceArray=a})}()):(window.showAutoDialog("请先到安全中心绑定手机"),g.go("personal.safe"),!1):(g.go("login"),!1)}app.import("/app/Tpl/web/js/directive/contenteditable.directive.js","contenteditable.directive"),app.import("/app/Tpl/web/js/directive/imgUpload.directive.js","imgUpload.directive"),app.import("/app/Tpl/web/js/directive/limitSize.directive.js","limitSize.directive"),app.import("/app/Tpl/web/js/service/service_min/public.service.min.js","public.service"),app.import("/app/Tpl/web/js/service/service_min/crowdFund.service.min.js","crowdFund.service"),app.import("/app/Tpl/web/js/service/service_min/address.service.min.js","address.service"),app.import("/app/Tpl/web/js/directive/integer.directive.js","integer.directive"),app.addController("addCrowdFundController",a),a.$inject=["$scope","$rootScope","$window","crowdFundService","publicService","addressService","$state","$filter"]}();