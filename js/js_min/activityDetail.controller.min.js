/*! yiqi_web 2016-12-31 */
!function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(){var b={deal_id:d.activityId,user_id:a.userInfo.id};e.getUserFocusFlag(b).success(function(a){return 200!=a.ret?(window.showAutoDialog(a.msg),!1):void(2e4==a.data.code?z.focusFlag=1==a.data.status:window.showAutoDialog(a.data.msg))})}function j(){var b={id:d.activityId,username:a.userInfo?a.userInfo.user_name:""};e.detail(b).success(function(a){if(200!=a.ret)return window.showAutoDialog(a.msg),!1;if(2e4==a.data.code){z.activityInfo=a.data.list[0],z.tagsArray=a.data.list[0].tags.split(","),z.sponsorInfo=a.data.sponsor[0],n(z.activityInfo.province+z.activityInfo.city+z.activityInfo.address),Date.parse(new Date)/1e3>z.activityInfo.end_time&&window.showAutoDialog("活动已结束"),window._bd_share_config={common:{bdSnsKey:{tsina:"89d1afaf46168b260f0a8adee885f71d",tqq:"c4ea495e3ee3f424b0118f72de250fb4"},bdSign:"off",bdMini:"2",bdMiniList:!1,bdStyle:"0",bdSize:"24",bdText:z.activityInfo.name,bdPic:z.activityInfo.image,bdComment:z.activityInfo.brief},share:{}},window._bd_share_main=null;var b="/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date/36e5);$("body").append("<script defer async='true' src='"+b+"'></script>")}else window.showAutoDialog(a.data.msg)})}function k(){var a={id:d.activityId};e.getTicket(a).success(function(a){if(200!=a.ret)return window.showAutoDialog(a.msg),!1;if(2e4==a.data.code){for(var b=0;b<a.data.list.length;b++)a.data.list[b].ticket_num>0&&("0"==a.data.list[b].ticket_price||""==a.data.list[b].ticket_price?z.freeTicketArray.push(a.data.list[b]):z.chargeTicketArray.push(a.data.list[b]));"0"==z.freeTicketArray.length&&"0"==z.chargeTicketArray.length&&window.showAutoDialog("门票已售完")}else window.showAutoDialog(a.data.msg)})}function l(){if(!a.userInfo.id)return window.showAutoDialog("请先登录"),!1;var b={deal_id:d.activityId,user_id:a.userInfo.id,username:a.userInfo.user_name};e.focusActivity(b).success(function(a){return 200!=a.ret?(window.showAutoDialog(a.msg),!1):void(2e4==a.data.code?(z.focusFlag=a.data.status,window.showAlertTip(a.data.msg)):window.showAutoDialog(a.data.msg))})}function m(a){z.selectTicketId==a?z.selectTicketId="":z.selectTicketId=a}function n(a){f.jsonp("https://api.map.baidu.com/geocoder/v2/?ak=f9vN5ry16uR26GXGGfgbcTELUqG1kmhX&output=json&&callback=JSON_CALLBACK&address="+a).success(function(b){if(0==b.status){var c=new BMap.Map("activityMap"),d=new BMap.Point(b.result.location.lng,b.result.location.lat);c.centerAndZoom(d,15);var e=new BMap.Marker(d);c.addOverlay(e),c.enableScrollWheelZoom(),e.disableDragging();var f={width:200,height:0,title:" "},g="<div style='font-size:14px;line-height:20px;margin-top:10px;'>"+a+"</div>",h=new BMap.InfoWindow(g,f);e.openInfoWindow(h,d),e.addEventListener("click",function(){this.openInfoWindow(h)})}else console.log("地理定位失败")})}function o(){return z.selectTicketId?void(z.show.joinDialog=!0):(window.showAlertTip("请先选择票种"),!1)}function p(){if(0==z.flag.joinFormFlag)return!1;var b={deal_id:d.activityId,user_id:a.userInfo.id,username:a.userInfo.user_name,nickname:z.joinForm.nickname,mobile:z.joinForm.mobile,email:z.joinForm.email,company:z.joinForm.company,qq:z.joinForm.qq,wechat:z.joinForm.wechat,sex:z.joinForm.sex,age:z.joinForm.age,department:z.joinForm.department,job:z.joinForm.job,address:z.joinForm.address,ticket_id:z.selectTicketId};a.$broadcast("public.show",["loading_panel"]),z.flag.joinFormFlag=!1,e.getUserSinUpForm(b).success(function(b){try{if(200!=b.ret)return window.showAutoDialog(b.msg),!1;if(2e4==b.data.code){var c={ticket_id:z.selectTicketId,deal_id:d.activityId,user_id:a.userInfo.id,username:a.userInfo.user_name,extends_id:b.data.extends_id};e.joinActivity(c).success(function(a){return 200!=a.ret?(window.showAutoDialog(a.msg),!1):void(2e4==a.data.code?a.data.sn&&"0"!=a.data.price?h.go("payMoney",{id:a.data.sn,price:a.data.price,num:"1",Project_type:"0",url:"personal.joinActivity"}):(z.show.joinDialog=!1,window.showAutoDialog(a.data.msg)):window.showAutoDialog(a.data.msg))})}else window.showAlertTip(b.data.msg)}catch(a){}finally{a.$broadcast("public.hide",["loading_panel"]),z.flag.joinFormFlag=!0}})}function q(){z.show.joinDialog=!1}function r(a){z.activePanel=a}function s(){var a={deal_id:d.activityId,pageSize:z.commentPageParams.pageSize,current:z.commentPageParams.current};g.getCommentList(a).success(function(a){if(200!=a.ret)window.showAutoDialog(a.msg);else if(2e4==a.data.code){z.commentArray=a.data.list,z.commentPageParams.page_count=a.data.page_count,z.comment_count=a.data.comment_count;for(var b=[],c=0;c<z.commentArray.length;c++)b.push(z.commentArray[c].id);z.getReplyList(b)}else window.showAutoDialog(a.data.msg)})}function t(a){var b={pid:a.join(",")};g.getReplyList(b).success(function(b){if(200!=b.ret)window.showAutoDialog(b.msg);else if(2e4==b.data.code)for(var c=0;c<a.length;c++)z.commentArray[c].list=b.data.list[a[c]];else window.showAutoDialog(b.data.msg)})}function u(){return function(a){parseInt(a)>0&&parseInt(a)<=z.commentPageParams.page_count?(z.commentPageParams.current=parseInt(a),z.getCommentList(),angular.element(c).scrollTop(0)):console.log("输入非法")}}function v(a,c,d,e,f){z.pid=c,z.reply_user_id=d,z.reply_nickname=e,z.showReplyBoxIndex=-1,z.replyPlaceholderIndex=-1,z.showCommentBoxIndex==f?z.showCommentBoxIndex=-1:(z.showCommentBoxIndex=f,b(function(){angular.element(a.target).closest("li").find("li.answer-item:first").find("textarea").focus()},100))}function w(a,c,d,e,f,g){z.pid=c,z.reply_user_id=d,z.reply_nickname=e,z.showCommentBoxIndex=-1,z.showReplyBoxIndex==f&&z.replyPlaceholderIndex==g?(z.showReplyBoxIndex=-1,z.replyPlaceholderIndex=-1):(z.showReplyBoxIndex=f,z.replyPlaceholderIndex=g,z.replyPlaceholder="回复 "+e,b(function(){angular.element(a.target).closest("ul").find("li:last").find("textarea").focus()},0))}function x(){if(!z.flag.addCommentFlag)return!1;if(0==z.commentText.toString().trim().length)return!1;if(!a.userInfo.id)return window.showAutoDialog("请先登录"),!1;var b={deal_id:d.activityId,user_id:a.userInfo.id,nickname:a.userInfo.nickname,content:z.commentText};a.$broadcast("public.show",["loading_panel"]),z.flag.addCommentFlag=!1,g.addComment(b).success(function(b){try{200!=b.ret?window.showAutoDialog(b.msg):2e4==b.data.code?(window.showAlertTip(b.data.msg),h.reload()):window.showAutoDialog(b.data.msg)}catch(a){}finally{a.$broadcast("public.hide",["loading_panel"]),z.flag.addCommentFlag=!0}})}function y(){if(!z.flag.addReplyFlag)return!1;if(0==z.replyText.toString().trim().length)return!1;if(!a.userInfo.id)return window.showAutoDialog("请先登录"),!1;var b={deal_id:d.activityId,user_id:a.userInfo.id,nickname:a.userInfo.nickname,content:z.replyText,pid:z.pid,reply_user_id:z.reply_user_id,reply_nickname:z.reply_nickname};a.$broadcast("public.show",["loading_panel"]),z.flag.addReplyFlag=!1,g.addComment(b).success(function(b){try{200!=b.ret?window.showAutoDialog(b.msg):2e4==b.data.code?(window.showAlertTip(b.data.msg),h.reload()):window.showAutoDialog(b.data.msg)}catch(a){}finally{a.$broadcast("public.hide",["loading_panel"]),z.flag.addReplyFlag=!0}})}angular.element(c).scrollTop(0),a.title="活动详情";var z=this;z.activePanel="detail",z.activityInfo={},z.sponsorInfo={},z.freeTicketArray=[],z.chargeTicketArray=[],z.tagsArray=[],z.selectTicketId="",z.focusFlag=!1,z.show={joinDialog:!1},z.flag={joinFormFlag:!0,addCommentFlag:!0,addReplyFlag:!0},z.joinForm={nickname:"",mobile:"",email:"",company:"",qq:"",wechat:"",sex:"",age:"",department:"",job:"",address:""},z.commentPageParams={showPage:5,pageSize:8,current:1,page_count:1,pageChange:u},z.commentArray=[],z.comment_count=0,z.replyPlaceholder="",z.showCommentBoxIndex=-1,z.showReplyBoxIndex=-1,z.replyPlaceholderIndex=-1,z.commentText="",z.replyText="",z.getUserFocusFlag=i,z.getActivityDetail=j,z.getTicket=k,z.focusActivity=l,z.selectTicket=m,z.showAlertDialog=o,z.alertDialogConfirm=p,z.alertDialogCancel=q,z.setActivePanel=r,z.setCommentBox=v,z.setReplyBox=w,z.getCommentList=s,z.getReplyList=t,z.addComment=x,z.addReply=y,function(){z.getActivityDetail(),z.getTicket(),a.userInfo&&z.getUserFocusFlag(),z.getCommentList()}()}app.import("/app/Tpl/web/js/service/service_min/activity.service.min.js","activity.service"),app.import("/app/Tpl/web/js/directive/tooltip.directive.js","tooltip.directive"),app.import("/app/Tpl/web/js/service/service_min/comment.service.min.js","comment.service"),app.addController("activityDetailController",a),a.$inject=["$rootScope","$timeout","$window","$stateParams","activityService","$http","commentService","$state"]}();