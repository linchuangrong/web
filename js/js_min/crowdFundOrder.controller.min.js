/*! yiqi_web 2016-12-30 */
!function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(){var b={deal_id:d.deal_id,user_id:d.user_id,item_id:d.item_id,price:d.price};f.getCreateOrder(b).success(function(b){return 200!=b.ret?(window.showAutoDialog(b.msg),!1):void(2e4==b.data.code?s.orderInfo=b.data.item:(window.showAutoDialog(b.data.msg),e.go(a.fromState,a.fromParams)))})}function j(){var b={id:a.userInfo.id,username:a.userInfo.user_name};h.getUserAddressList(b).success(function(a){if(200!=a.ret)window.showAutoDialog(a.msg);else if(2e4==a.data.code){s.addressArray=a.data.list;for(var b=0;b<s.addressArray.length;b++)if("1"==s.addressArray[b].is_default){s.submitForm.address_id=s.addressArray[b].id;break}}else window.showAutoDialog(a.data.msg)})}function k(a,b,c){function d(){s.addAddressForm.address.city=""}function e(a){s[b]=a,c&&c()}g.getCityList(s.provinceArray,a,d,e)}function l(){s.submitForm.shopNum++}function m(){s.submitForm.shopNum--,s.submitForm.shopNum<=0&&(s.submitForm.shopNum=1)}function n(){s.submitForm.shopNum=parseInt(s.submitForm.shopNum),s.submitForm.shopNum<=0&&(s.submitForm.shopNum=1)}function o(){if(!s.addAddressForm.address.province||!s.addAddressForm.address.city)return window.showAutoDialog("请先选择省份、城市地区"),!1;if(0==s.flag.addAddressFlag)return!1;var b={id:a.userInfo.id,username:a.userInfo.user_name,address:JSON.stringify(s.addAddressForm.address),zip:s.addAddressForm.zip.toString(),consignee:s.addAddressForm.consignee,mobile:s.addAddressForm.mobile};a.$broadcast("public.show",["loading_panel"]),s.flag.addAddressFlag=!1,h.addAddress(b).success(function(b){try{if(200!=b.ret)return window.showAutoDialog(b.msg),!1;2e4==b.data.code?(window.showAlertTip(b.data.msg),e.reload()):window.showAutoDialog(b.data.msg)}catch(a){}finally{a.$broadcast("public.hide",["loading_panel"]),s.flag.addAddressFlag=!0}})}function p(a){s.edit_dialog_mask=!0,s.edit_dialog=!0}function q(){s.edit_dialog_mask=!1,s.edit_dialog=!1}function r(){return 0!=s.flag.creatOrderSubmitFlag&&(!!s.agree&&(s.submitForm.shopNum=parseInt(s.submitForm.shopNum),s.submitForm.shopNum>=1||(s.submitForm.shopNum=1),"1"!=s.submitForm.is_invoice||s.submitForm.invoice_title?s.submitForm.address_id?(a.$broadcast("public.show",["loading_panel"]),s.flag.creatOrderSubmitFlag=!1,void f.creatOrderSubmit(s.submitForm).success(function(b){try{if(200!=b.ret)return window.showAutoDialog(b.msg),!1;2e4==b.data.code?e.go("payMoney",{id:b.data.list.requestNo,price:b.data.list.deal_price,num:b.data.list.num,Project_type:"0",url:"personal.joinCrowdFund"}):window.showAutoDialog(b.data.msg)}catch(a){}finally{a.$broadcast("public.hide",["loading_panel"]),s.flag.creatOrderSubmitFlag=!0}})):(window.showAlertTip("请选择地址"),!1):(window.showAlertTip("请填写发票抬头"),!1)))}angular.element(b).scrollTop(0),a.title="众筹下单";var s=this;return a.userInfo.id?d.deal_id&&d.user_id&&d.item_id?d.user_id!=a.userInfo.id?(window.showAutoDialog("访问出错"),e.go("crowdFundList"),!1):(s.edit_dialog_mask=!1,s.edit_dialog=!1,s.orderInfo={},s.addressArray=[],s.provinceArray=[],s.cityArray=[],s.addAddressForm={address:{province:"",city:"",location:""},zip:"",consignee:"",mobile:""},s.flag={addAddressFlag:!0,creatOrderSubmitFlag:!0},s.submitForm={deal_id:d.deal_id,user_id:d.user_id,item_id:d.item_id,price:d.price,shopNum:"1",is_invoice:0,invoice_title:"",address_id:""},s.agree=!0,s.getCreateOrder=i,s.getAddressList=j,s.getCityList=k,s.addShopNum=l,s.decreaseShopNum=m,s.setShopNum=n,s.showEditDialog=p,s.editDialogCancel=q,s.addAddressSubmit=o,s.creatOrderSubmit=r,void function(){s.getCreateOrder(),s.getAddressList(),g.getProvinceList(function(a){s.provinceArray=a})}()):(window.showAutoDialog("访问出错"),e.go("crowdFundList"),!1):(e.go("login"),!1)}app.import("/app/Tpl/web/js/service/service_min/crowdFund.service.min.js","crowdFund.service"),app.import("/app/Tpl/web/js/service/service_min/address.service.min.js","address.service"),app.import("/app/Tpl/web/js/service/service_min/personal.service.min.js","personal.service"),app.addController("crowdFundOrderController",a),a.$inject=["$rootScope","$window","$timeout","$stateParams","$state","crowdFundService","addressService","personalService"]}();