/*! yiqi_web 2016-12-30 */
!function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j){function k(){laydate({elem:"#deal_days",istime:!0,format:"YYYY-MM-DD hh:mm:ss",min:h("toTime")(e.dateNowStamp),isclear:!1,istoday:!1,choose:function(a){b.$apply(function(){v.submitForm.deal_days=a})}})}function l(a){d.getCrowdFundTypeList().success(function(b){return 200!=b.ret?(window.showAutoDialog(b.msg),!1):void(2e4==b.data.code?(v.crowdFundTypeArray=b.data.list,a&&a()):window.showAutoDialog(b.data.msg))})}function m(a,b){v.submitForm.welfare_id=a,v.submitForm.welfare_name=b}function n(a,b,c){function d(){v.submitForm.address.city=""}function e(a){v[b]=a,c&&c()}f.getCityList(v.provinceArray,a,d,e)}function o(b){if("crowdFundPanel2"==b){if(!v.submitForm.welfare_id)return window.showAlertTip("请选择众筹类型"),!1;if(!v.submitForm.title)return window.showAlertTip("请填写项目名称"),!1;if(!v.submitForm.brief)return window.showAlertTip("请填写筹款目的"),!1;if(!v.submitForm.address.province)return window.showAlertTip("请选择省份"),!1;if(!v.submitForm.address.city)return window.showAlertTip("请选择城市"),!1;if(!v.submitForm.address.location)return window.showAlertTip("请填写详细地址"),!1;if(!a.submitForm.limit_price.$valid)return window.showAlertTip("请填写正确的筹资金额"),!1;if(!v.submitForm.deal_days)return window.showAlertTip("请填写筹资结束时间"),!1;if(!v.submitForm.tags_match)return window.showAlertTip("请填写自定义标签"),!1;if(!v.submitForm.image)return window.showAlertTip("请上传封面图片"),!1}angular.element(c).scrollTop(0),v.showPanel={crowdFundPanel1:!1,crowdFundPanel2:!1},v.showPanel[b]=!0}function p(){v.show.add_repay_dialog=!0}function q(){if(0==v.flag.addRepayFlag)return!1;if(!v.repayForm.type)return window.showAlertTip("请选择回报类型"),!1;if("1"==v.repayForm.type||"2"==v.repayForm.type){var a=/^\-?\d*$/;if(!v.repayForm.item_name)return window.showAlertTip("请填写回报标题"),!1;if(!v.repayForm.description)return window.showAlertTip("请填写回报内容"),!1;if(!(v.repayForm.delivery_fee&&v.repayForm.delivery_fee>0))return window.showAlertTip("请填写正确的支持金额"),!1;if(!(v.repayForm.limit_user&&a.test(v.repayForm.limit_user)&&v.repayForm.limit_user>1))return window.showAlertTip("人数上限为大于0的整数"),!1;if(!(v.repayForm.repaid_day&&a.test(v.repayForm.repaid_day)&&v.repayForm.repaid_day>0))return window.showAlertTip("请填写正确的回报时间值"),!1;if(!v.repayForm.item_image)return window.showAlertTip("请上传图片"),!1}var c={username:b.userInfo.user_name,type:v.repayForm.type,item_name:v.repayForm.item_name,description:v.repayForm.description,delivery_fee:v.repayForm.delivery_fee,limit_user:v.repayForm.limit_user,repaid_day:v.repayForm.repaid_day,item_image:v.repayForm.item_image};b.$broadcast("public.show",["loading_panel"]),v.flag.addRepayFlag=!1,d.creatRepay(c).success(function(a){try{if(200!=a.ret)return window.showAutoDialog(a.msg),!1;2e4==a.data.code?(window.showAlertTip(a.data.msg),v.show.add_repay_dialog=!1,v.repayArray.push(a.data.list),v.submitForm.item_id.push(a.data.list.id)):window.showAutoDialog(a.data.msg)}catch(a){}finally{b.$broadcast("public.hide",["loading_panel"]),v.flag.addRepayFlag=!0}})}function r(){v.show.add_repay_dialog=!1}function s(a,b){v.repayArray.splice(a,1),v.submitForm.item_id.splice(a,1),window.showAlertTip("删除成功")}function t(a){var b={item_id:a};d.getRepayInfo(b).success(function(a){return 200!=a.ret?(window.showAutoDialog(a.msg),!1):void(2e4==a.data.code&&(v.repayArray.push(a.data.list),v.submitForm.item_id.push(a.data.list.id)))})}function u(){if(0==v.flag.submitFlag)return!1;if(v.submitForm.description.indexOf("<img")<0&&v.submitForm.description.trim().length<30)return window.showAutoDialog("详情描述字数过少，请更加详细地描述一下！"),!1;if("众筹"==v.submitForm.welfare_name)if("1"==v.submitForm.hasRepay){if(0==v.submitForm.item_id.length)return window.showAlertTip("请添加至少一个回报"),!1}else v.repayArray=[],v.submitForm.item_id=[];else v.repayArray=[],v.submitForm.item_id=[];var a={deal_id:i.id,uid:b.userInfo.id,username:b.userInfo.user_name,welfare_id:v.submitForm.welfare_id,title:v.submitForm.title,brief:v.submitForm.brief,address:JSON.stringify({province:v.submitForm.address.province,city:v.submitForm.address.city,location:v.submitForm.address.location}),limit_price:v.submitForm.limit_price,deal_days:h("toTimeStamp")(v.submitForm.deal_days),tags_match:v.submitForm.tags_match,image:v.submitForm.image,vedio:v.submitForm.vedio,description:v.submitForm.description,item_id:v.submitForm.item_id.join(",")};b.$broadcast("public.show",["loading_panel"]),v.flag.submitFlag=!1,d.addCrowdFund(a).success(function(a){try{if(200!=a.ret)return window.showAutoDialog(a.msg),!1;2e4==a.data.code?(window.showAlertTip(a.data.msg),v.show.add_repay_dialog=!1,g.go("personal.myCrowdFund")):window.showAutoDialog(a.data.msg)}catch(a){}finally{b.$broadcast("public.hide",["loading_panel"]),v.flag.submitFlag=!0}})}angular.element(c).scrollTop(0),b.title="发起众筹";var v=this;return"0"!=b.userInfo.identity_conditions?(window.showAlertTip(["您不是主办方，无权限发布筹款",3e3]),g.go("index"),!1):b.userInfo.mobile?(v.crowdFundTypeArray=[],v.provinceArray=[],v.cityArray=[],v.repayArray=[],v.show={add_repay_dialog:!1},v.flag={addRepayFlag:!0,submitFlag:!0},v.showPanel={crowdFundPanel1:!0,crowdFundPanel2:!1},v.repayForm={type:1,item_name:"",description:"",delivery_fee:null,limit_user:null,repaid_day:null,item_image:""},v.submitForm={welfare_id:"",welfare_name:"",title:"",brief:"",address:{province:"",city:"",location:""},limit_price:null,deal_days:h("toTime")(e.dateOneMonthStamp),tags_match:"",image:"",vedio:"",description:"",item_id:[]},v.getCrowdFundTypeList=l,v.setCrowdFundType=m,v.setDealDays=k,v.getCityList=n,v.goToPanel=o,v.showRepayDialog=p,v.alertDialogConfirm=q,v.alertDialogCancel=r,v.deleteRepay=s,v.getRepayInfo=t,v.submit=u,void function(){if(i.id){var a={id:i.id,username:b.userInfo.user_name};d.detail(a).success(function(a){if(200!=a.ret)return window.showAutoDialog(a.msg),!1;if(2e4==a.data.code){v.editForm=a.data.list[0],v.submitForm.title=v.editForm.name,v.submitForm.brief=v.editForm.brief,v.submitForm.address.location=v.editForm.address,v.submitForm.limit_price=parseFloat(v.editForm.limit_price),v.submitForm.deal_days=h("toTime")(v.editForm.deal_days),v.submitForm.tags_match=v.editForm.tags_match,v.submitForm.image=v.editForm.image,v.submitForm.vedio=v.editForm.vedio,v.submitForm.description=v.editForm.description,f.getProvinceList(function(a){v.provinceArray=a,v.submitForm.address.province=v.editForm.province,v.getCityList(v.editForm.province,"cityArray",function(){v.submitForm.address.city=v.editForm.city})}),v.getCrowdFundTypeList(function(){v.submitForm.welfare_id=v.editForm.welfare_id;for(var a=0;a<v.crowdFundTypeArray.length;a++)v.submitForm.welfare_id==v.crowdFundTypeArray[a].id&&(v.submitForm.welfare_name=v.crowdFundTypeArray[a].name)});for(var b=v.editForm.item_id.split(","),c=0;c<b.length;c++){if(0==b[c])return v.submitForm.hasRepay="0",!1;v.submitForm.hasRepay="1",v.getRepayInfo(b[c])}}else window.showAutoDialog(a.data.msg)})}}()):(window.showAutoDialog("请先到安全中心绑定手机"),g.go("personal.safe"),!1)}app.import("/app/Tpl/web/js/directive/contenteditable.directive.js","contenteditable.directive"),app.import("/app/Tpl/web/js/directive/imgUpload.directive.js","imgUpload.directive"),app.import("/app/Tpl/web/js/service/service_min/public.service.min.js","public.service"),app.import("/app/Tpl/web/js/service/service_min/crowdFund.service.min.js","crowdFund.service"),app.import("/app/Tpl/web/js/service/service_min/address.service.min.js","address.service"),app.import("/app/Tpl/web/js/directive/integer.directive.js","integer.directive"),app.addController("updateCrowdFundController",a),a.$inject=["$scope","$rootScope","$window","crowdFundService","publicService","addressService","$state","$filter","$stateParams","$timeout"]}();